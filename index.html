<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <link href="css/music.css" rel="stylesheet">
    <script src="js/jquery-1.12.4.js"></script>
    <script src="js/prettify.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.scrollbar.js"></script>
    <script src="js/player.js"></script>

</head>
<body>
    <div class="header">
        <h1 class="logo"><a href="http://localhost:8080" ></a> </h1>
        <ul class="register" style="display: none">
            <li>设置</li>
            <li>登录</li>
        </ul>
        <div class="player_login__guide">
            <a href="javascript:;" class="download"><i class="player_login__guide_icon"></i>客户端下载</a>
        </div>
    </div>
    <div class="content">
        <div class="content-in">
            <div class="content-left ">
                <div class="content_toolbar">
                    <span><i class="i0"></i>收藏</span>
                    <span><i class="i1"></i>添加到</span>
                    <span><i class="i2"></i>下载</span>
                    <span><i class="i3"></i>删除</span>
                    <span><i class="i4"></i>清空列表</span>
                </div>
                <div class="content_list scrollbar-macosx">
                    <ul>
                        <div class="list_top ">
                            <li >
                                <div class="list_check"></div>
                                <div class="list_number"></div>
                                <div class="list_name">歌曲</div>
                                <div class="list_singer">歌手</div>
                                <div class="list_time">时长</div>
                            </li>
                        </div>
                        <div class="list_content">
                           <!--


                            <li  class="list_music">
                                <div class="list_check "><i></i></div>
                                <div class="list_number">1</div>
                                <div class="list_name">只要平凡
                                    <div class="list_menu">
                                        <a href="javascript:;" title="播放"></a>
                                        <a href="javascript:;" title="添加到歌单"></a>
                                        <a href="javascript:;" title="下载"></a>
                                        <a href="javascript:;" title="分享"></a>
                                    </div>
                                </div>
                                <div class="list_singer">张杰/张碧晨</div>
                                <div class="list_time">
                                    <span>04：06</span>
                                    <a href="javascript:;" title="删除"></a>
                                </div>
                            </li>
                            -->
                        </div>
                    </ul>
                </div>
            </div>
            <div class="content-right ">
                <div class="song_info">
                    <a href="javacript:;" class="song_info_pic">
                        <img src="images/album.jpg" alt="">
                    </a>
                    <div class="song_info_name">歌曲名称：
                        <a href="javascript:;" >江南</a>
                    </div>
                    <div class="song_info_singer">歌手名：
                        <a href="javascript:;" >张三</a>
                    </div>
                    <div class="song_info_album">专辑名：
                        <a href="javascript:;" >江南系列</a>
                    </div>
                </div>
                <div class="song_lyric scrollbar-macosx scroll-content" >
                    <ul>
                        <li class="cur">第一条歌词</li>
                        <li>第二条歌词</li>

                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="footer-in">
            <a href="javascript:;" class="music_pre"></a>
            <a href="javascript:;" class="music_play "></a>
            <a href="javascript:;" class="music_next"></a>
            <div class="music_progress_info">
                <div class="music_progress_top">
                    <span class="music_progress_name">只要平凡 -张杰/张碧晨</span>
                    <span class="music_progress_time">00:00 / 04:06</span>
                </div>
                <div class="music_progress_bar">
                    <div class="music_progress_line">
                        <div class="music_progress_dot"></div>
                    </div>
                </div>
            </div>
            <a href="javascript:;" class="music_mode"></a>
            <a href="javascript:;" class="music_fav music_fav"></a>
            <a href="javascript:;" class="music_down"></a>
            <a href="javascript:;" class="music_comment"></a>
            <a href="javascript:;" class="music_only"></a>
            <div class="music_voice_info">
                <a href="javascript:;" class="music_voice_icon"></a>
                <div class="music_voice_bar">
                    <div class="music_voice_line">
                        <div class="music_voice_dot"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mask_bg"></div>
    <div class="mask"></div>
    <audio></audio>
    <script>
        $(function(){
            jQuery('.scrollbar-macosx').scrollbar();
            //***************************** 进度条prgress 对象 ************************************************
            function Progress($progress_bar,$progress_line,$progress_dot){
                return new Progress.prototype.init($progress_bar,$progress_line,$progress_dot);
            }
            Progress.prototype = {
                constructor:Progress,
                isMove:false,
                init:function($progress_bar,$progress_line,$progress_dot){
                    this.$progress_bar = $progress_bar;
                    this.$progress_line = $progress_line;
                    this.$progress_dot = $progress_dot;
                },
                progressClick:function(callBack){
                    var $this = this;
                    //监听背景的点击
                    this.$progress_bar.click(function(event){
                        //获取背景距离窗口默认位置
                        var normalLeft =  $(this).offset().left;
                        var eventLeft = event.pageX;
                        //设置背景宽度
                        $this.$progress_line.css("width",eventLeft - normalLeft);
                        $this.$progress_dot.css("left",eventLeft - normalLeft);
                        //计算进度条的比例
                        var    value = (eventLeft - normalLeft)/$(this).width();
                        callBack(value);
                    })
                },
                progressMove:function(callBack){

                    var $this = this;
                    var barWidth =this. $progress_bar.width();
                    //1.监听鼠标按下事件
                    this.$progress_bar.mousedown(function(){
                        $this.isMove = true;
                        //2.监听鼠标移动事件
                        var normalLeft =  $(this).offset().left;

                        $(document).mousemove(function() {
                            //获取背景距离窗口默认位置

                            var eventLeft = event.pageX;
                            var offset = eventLeft - normalLeft;
                            if(offset>barWidth) return;
                            //设置背景宽度
                            if (eventLeft < normalLeft) {//小于最左边
                                $this.$progress_line.css("width","1px");
                                $this.$progress_dot.css("left","1px");
                            }else {
                                $this.$progress_line.css("width", eventLeft - normalLeft);
                                $this.$progress_dot.css("left", eventLeft - normalLeft);
                            }
                        })
                        //3.监听鼠标抬起事件
                        $(document).mouseup(function(){
                            var eventLeft = event.pageX;
                            $(document).mousemove().off();
                            var    value = (eventLeft - normalLeft)/$(this).width();
                            callBack(value);
                            $this.isMove = false;
                        })

                    })

                },
                setProgress:function(value){
                    if (this.isMove) return;
                    if(value<0 ||   value >100) return;
                    this.$progress_line.css("width",value+"%");
                    this.$progress_dot.css("left",value+"%");
                 }
            }
            Progress.prototype.init.prototype = Progress.prototype;
            window.Progrss = Progress;
            //*******************************进度条lyric对象*********************************************
            function Lyric(path){
                return new  Lyric.prototype.init(path);
            }
            Lyric.prototype = {
                constructor: Lyric,
                init:function(path){
                    this.path = path;
                },
                loadMusic:function(){
                    var $this = this;
                    $.ajax({
                        url:$this.path,
                        dataType:"text",
                        success:function(data){
                         $(".song_lyric").find("ul").html("");
                         $this.parseLyric(data);
                        },
                        error:function(e){
                            console.log(e);
                        }
                    })
                },
                parseLyric:function(data){
                    var array = data.split("\n");
                    //遍历取出每一条歌词
                    $.each(array,function(index,ele){
                        $(".song_lyric").find("ul").append("<li>"+ele+"</li>");
                        console.log(ele);
                    })
                  //  $(".song_lyric").find("ul").html(data);
                }


                }

            Lyric.prototype.init.prototype =  Lyric.prototype;
            window. Lyric =  Lyric;
            //******************************************************************************************
            var $audio = $("audio");
            var player = new Player($audio);
            var $progress_bar = $(".music_progress_bar");
            var $progress_line = $(".music_progress_line");
            var $progress_dot = $(".music_progress_dot");

            var $voiceprogress_bar = $(".music_voice_bar");
            var $voiceprogress_line = $(".music_voice_line");
            var $voiceprogress_dot = $(".music_voice_dot");
            //var progress = Progress($progress_bar,$progress_line,$progress_dot);
            var pro = Progress($progress_bar,$progress_line,$progress_dot);
            var voicepro = Progress($voiceprogress_bar,$voiceprogress_line,$voiceprogress_dot);
            pro.progressClick(function (value){
                player.audio.currentTime =  player.audio.duration * value;
                console.log(value);
            });
            pro.progressMove(function (value){
                player.audio.currentTime =  player.audio.duration * value;
            });
            voicepro.progressClick(function (value){
                voiceControl(value);
            })
            voicepro.progressMove(function (value){
                voiceControl(value);
            });
            console.log($voiceprogress_bar);
            //1.加载歌曲
            getPlayerList();
            function getPlayerList(){
                var urls = location.search;
                var uid = urls.substr(urls.lastIndexOf("=") + 1);

                $.ajax({
                   // url:"./source/musiclist.json",
                    url:"http://localhost:8081/getPlayListmusic?uid="+uid,
                    dataType:"json",
                    success:function(data){
                        player.musicList = data;
                       //遍历获取到的每一个歌曲
                        $.each(data,function(index,music){
                            var $item = createMusicItem(index,music);
                        })
                        initMusicinfo(data[0]);
                        initMusicLyric(data[0]);
                    },
                    error:function(e){
                        console.log(e);
                    }
                })
            }
            //定义一个方法，创建歌曲
            var $musicList = $(".list_content");
            function createMusicItem(index,music){
                var $item = $("<li  class='list_music'>" +
                "<div class='list_check '><i></i></div>" +
                "<div class='list_number'><p>"+(index+1)+"</p><span></span></div>" +
                "<div class='list_name'>"+music.name+
                "<div class='list_menu'>" +
                "<a href='javascript:;' title='播放' class='mplay '></a>" +
                "<a href='javascript:;' title='添加到歌单'></a>" +
                "<a href='javascript:;' title='下载'></a>" +
                "<a href='javascript:;' title='分享'></a>" +
                "</div></div><div class='list_singer'>"+music.singer+"</div>" +
                "<div class='list_time'>" +
                "<span>"+music.time+"</span>" +
                "<a href='javascript:;' title='删除' class='mdel'></a></div></li>");

                $musicList.append($item);
                $item.get(0).index = index;
                $item.get(0).music = music;
                return $item;
            }





            //*******************************************事件监听*************************************************
            $(".content_list").delegate(".list_music","mouseenter",function(){//鼠标移入歌曲
                //显示子菜单
                $(this).find(".list_menu").show();
                $(this).siblings(".list_music").find(".list_menu").hide();

                //隐藏时间
                $(this).siblings(".list_music").find(".list_time>a").hide();
                $(this).siblings(".list_music").find(".list_time>span").show();
                $(this).find(".list_time>span").hide();
                $(this).find(".list_time>a").show();

            })
            $(".content_list").on("mouseleave",".list_music",function(){//鼠标移出歌曲
                //隐藏子菜单

                $(".list_music").find(".list_menu").hide();
                $(".list_music").find(".list_time>span").show();
                //显示时间
                $(this).find(".list_time>a").hide();
            })

            $(".content_list").delegate(".list_music","dblclick",function(){//歌曲被双击

                var $item  = $(this);
                player.PlayMusic($item.get(0).index,$item.get(0).music,$item.get(0));
                initMusicinfo($item.get(0).music);
                initMusicLyric($item.get(0).music);
                return false;
            })
            $(".content_list").delegate(".list_music>.list_check>i","click",function(){//多选框被单击

                $(this).toggleClass("list_checked");
                return false;
            })
            $(".content_list").delegate(".list_menu>.mplay","click",function(){//播放按钮被单击
                $(this).parents(".list_music").dblclick();
                return false;
            })
            $(".content_list").delegate(".list_music>.list_name>.list_menu>a","mouseenter",function() {//歌曲菜单鼠标移入
                $(this).css("opacity",1);
            })
            $(".content_list").delegate(".list_music>.list_name>.list_menu>a","mouseout",function() {//歌曲菜单鼠标移出
                $(this).css("opacity",0.5);
            })
            //底部播放按钮监听
            $(".music_play").click(function(){
                //判断是否播放过
                if(player.currentindex==-1){
                    //没有播放过音乐
                   $(".list_music").eq(0).find(".mplay").trigger("click");
                }else{
                    //播放过音乐
                    $(".list_music").eq(player.currentindex).find(".mplay").trigger("click");
                }
            })
            //底部上一首按钮监听
            $(".music_pre").click(function(){
                var index = player.currentindex -1;
                if(index<0){
                    index = player.musicList.length -1;
                }
                $(".list_music").eq(index).find(".mplay").trigger("click");
            })
            //底部下一首按钮监听
            $(".music_next").click(function(){
                var index = player.currentindex +1;
                if(index> player.musicList.length-1){
                    index = 0;
                }
                $(".list_music").eq(index).find(".mplay").trigger("click");
            })
            //歌曲列表删除按钮监听
            $(".content_list").delegate(".mdel","click",function(){

                var $item = $(this).parents(".list_music");
                //判断是否是当前播放的歌曲
                console.log("当前:"+player.currentindex+"/下一个:"+([player.currentindex+1]));
                if($item.get(0).index == player.currentindex){
                    $(".music_next").trigger("click");
                    //改变当前播放歌曲的值
                   /* var index = player.currentindex +1;
                    console.log("index:"+index);
                    if(index> player.musicList.length-1){
                        index = 0;
                    }
                    console.log(player.musicList.length);
                    player.currentindex = index;
                    console.log(player.currentindex);*/
                }

                $item.remove();

                //删除列表里数据
                player.musicList.splice($item.get(0).index,1);
                if($item.get(0).index < player.currentindex){
                    player.currentindex = player.currentindex-1;
                }
                //重新排序
                $(".list_music").each(function(index,ele){
                    ele.index = index;
                    $(ele).find(".list_number>p").text(index+1);
                })
                return false;
            })
            player.$audio.on("timeupdate",function(){
                var currentTime = player.audio.currentTime;
                var duration = player.audio.duration;
                var timeStr = formateDate(currentTime,duration);
                if(parseInt(currentTime)==parseInt(duration)){
                    $(".music_next").click();
                }
                //同步时间
                $(".music_progress_time").text(timeStr);
                //同步进度条
                var value = (currentTime / duration) * 100;
                pro.setProgress(value);
            })

            //音乐按钮的监听
            $(".music_voice_icon").click(function(){
                $(this).toggleClass("music_voice_icon2");
                if($(this).hasClass("music_voice_icon2")){
                    //没声音
                    voiceControl(0);
                }else{
                    //有声音
                    voiceControl(1);
                }
            })
            //*******************************************函数*************************************************
            function voiceControl(value){
                if(value<0 || value>1) return;
                player.audio.volume = value;
            }
            function formateDate(currentTime,duration){
                var endMin = parseInt(duration / 60);
                var endSec = parseInt(duration % 60);
                if(endMin < 10){
                    endMin = "0" + endMin;
                }
                if(endSec < 10){
                    endSec = "0" + endSec;
                }

                var startMin = parseInt(currentTime / 60);
                var startSec = parseInt(currentTime % 60);
                if(startMin < 10){
                    startMin = "0" + startMin;
                }
                if(startSec < 10){
                    startSec = "0" + startSec;
                }
                return startMin + ":" + startSec + " / " + endMin + ":" + endSec;
            }
            function  initMusicinfo(music){
                var $musicName = $(".song_info_name>a");
                var $musicSinger = $(".song_info_singer>a");
                var $musicAlbum = $(".song_info_album>a");
                var $musicCover = $(".song_info_pic>img");
                var $musicinfo = $(".music_progress_name");
                var $musictime = $(".music_progress_time");
                var $musicbg = $(".mask_bg");
                //修改歌曲信息
                $musicCover.attr("src",music.cover);
                $musicName.text(music.name);
                $musicSinger.text(music.singer);
                $musicAlbum.text(music.album);
                $musicinfo.text(music.name+" -"+music.singer);
                $musictime.text("00:00 / "+music.time);
                $musicbg.css("background","url('"+music.cover+"')  no-repeat 0 0");
                $musicbg.css("background-size"," cover");
            }
            function  initMusicLyric(music){
                //var lyric = new Lyric(music.link_lrc);
                var lyric = new Lyric(music.linklrc);
                lyric.loadMusic();
            }
        })
    </script>
</body>
</html>